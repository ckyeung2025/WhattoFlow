# Workflow 收件人選擇器功能

## 📋 **功能概覽**

Workflow 收件人選擇器是一個全新的專用控件，用於在工作流設計器中選擇收件人。該控件支持多種收件人來源，包括用戶、聯絡人、廣播群組、標籤和流程啟動人，並支持多選功能。

## 🏗️ **系統架構**

### **核心組件**

#### 1. RecipientSelector.js
- **位置**: `src/components/WorkflowDesigner/components/RecipientSelector.js`
- **功能**: 主要的收件人選擇器組件
- **特性**:
  - 三個標籤頁：Users、Contact List、Workflow Initiator
  - 支持多選和單選模式
  - 實時搜尋和過濾
  - 當前選擇的視覺化顯示
  - 自動生成最終的電話號碼列表

#### 2. RecipientModal.js
- **位置**: `src/components/WorkflowDesigner/modals/RecipientModal.js`
- **功能**: 收件人選擇的模態框包裝器
- **特性**:
  - 統一的模態框界面
  - 支持自定義占位符和多選模式
  - 自動關閉和確認機制

### **後端 API**

#### UsersController.cs
- **端點**: `GET /api/users`
- **功能**: 獲取所有用戶列表
- **認證**: 需要 JWT Token 認證
- **過濾**: 前端會過濾出有電話號碼且狀態為活躍的用戶
- **返回數據**:
  ```json
  [
    {
      "id": "guid",
      "name": "張三",
      "phone": "85212345678",
      "email": "zhang@example.com",
      "isActive": true,
      "companyId": "guid"
    }
  ]
  ```

#### WorkflowExecutionsController.cs
- **新增端點**: `GET /api/workflow-executions/initiators`
- **功能**: 查詢 workflow_executions 表的 InitiatedBy 字段
- **返回數據**:
  ```json
  {
    "data": [
      {
        "id": "85296366318",
        "phone": "85296366318",
        "name": "85296366318",
        "initiatedAt": "2025-01-15T10:30:00Z",
        "executionCount": 5
      }
    ]
  }
  ```

## 🚀 **功能詳情**

### **1. Users Tab - 用戶選擇**

#### **功能特性**
- **多選支持**: 支持選擇多個用戶
- **搜尋功能**: 按姓名或電話號碼搜尋
- **視覺化選擇**: 顯示用戶頭像、姓名和電話
- **即時反饋**: 選中狀態的即時顯示

#### **數據來源**
- **API 端點**: `GET /api/users`
- **認證**: 需要 JWT Token 認證
- **過濾條件**: 只顯示有電話號碼且狀態為活躍的用戶
- **後備機制**: 如果 API 失敗，會使用模擬數據作為後備

#### **選擇結果**
- 生成格式：`85212345678,85287654321,85211223344`
- 電話號碼格式：區號+電話號碼，無+號無空格

### **2. Contact List Tab - 聯絡人選擇**

#### **功能特性**
- **聯絡人選擇**: 從 Contact List 系統選擇聯絡人
- **廣播群組選擇**: 使用標籤式選擇器選擇廣播群組（會包含群組內所有聯絡人）
- **標籤選擇**: 使用標籤式選擇器選擇標籤（會包含標籤對應的所有聯絡人）
- **組合選擇**: 支持同時選擇聯絡人、群組和標籤
- **視覺化選擇**: 廣播群組和標籤使用可點擊的標籤樣式，選中時會變色

#### **數據來源**
- **聯絡人**: `contactApi.getContacts()`
- **廣播群組**: `broadcastGroupApi.getGroups()`
- **標籤**: `hashtagApi.getHashtags()`

#### **選擇邏輯**
1. 直接選擇的聯絡人
2. 廣播群組內的所有聯絡人
3. 標籤對應的所有聯絡人
4. 自動去重並生成最終電話號碼列表

### **3. Workflow Initiator Tab - 流程啟動人選擇**

#### **功能特性**
- **固定功能**: 不是選擇具體的啟動人，而是啟用流程啟動人功能
- **自動替換**: 在流程執行時自動替換為實際的流程啟動人
- **單一選項**: 只有一個勾選框，勾選後啟用此功能
- **執行時解析**: 系統會在流程實例執行時從 workflow_executions 表的 InitiatedBy 字段獲取實際啟動人

#### **工作原理**
- **設計時**: 用戶勾選"使用流程啟動人"選項
- **存儲格式**: 在收件人字段中存儲 `${initiator}` 特殊標記
- **執行時**: 系統自動將 `${initiator}` 替換為實際的流程啟動人電話號碼
- **適用場景**: 向啟動流程的用戶發送消息或等待其回覆

#### **數據格式**
- **設計時存儲**: `${initiator}` (特殊標記)
- **執行時替換**: 實際的流程啟動人電話號碼 (區號+電話號碼格式)
- **替換邏輯**: 從當前流程實例的 InitiatedBy 字段獲取

## 🎨 **用戶界面**

### **標籤頁設計**
- **Users Tab**: 用戶圖標 + "用戶"
- **Contact List Tab**: 聯絡人圖標 + "聯絡人"  
- **Workflow Initiator Tab**: 播放圖標 + "流程啟動人"

### **選擇顯示**
- **當前選擇卡片**: 顯示所有已選擇的收件人
- **標籤分類**: 不同顏色標籤區分不同來源
  - 藍色：用戶
  - 綠色：聯絡人
  - 橙色：廣播群組
  - 紫色：標籤
  - 紅色：流程啟動人 (顯示"執行時自動替換")
- **清除功能**: 支持單個清除和全部清除

### **搜尋功能**
- **實時搜尋**: 輸入即時過濾結果
- **多字段搜尋**: 支持姓名、電話、郵箱等字段搜尋
- **搜尋圖標**: 統一的搜尋圖標設計

### **標籤式選擇**
- **廣播群組**: 使用藍色標籤樣式，選中時變為藍色背景
- **標籤**: 使用綠色標籤樣式，選中時變為綠色背景，顯示 # 前綴
- **空狀態**: 當沒有數據時顯示友好的空狀態提示
- **響應式布局**: 標籤自動換行，適應不同屏幕尺寸

## 🔧 **集成方式**

### **節點類型支持**

#### 1. sendWhatsApp 節點
- **字段**: `to`
- **功能**: 發送 WhatsApp 消息的收件人
- **多選**: 支持多個收件人

#### 2. sendWhatsAppTemplate 節點  
- **字段**: `to`
- **功能**: 發送 WhatsApp 模板消息的收件人
- **多選**: 支持多個收件人

#### 3. waitReply 節點
- **字段**: `specifiedUsers`
- **條件**: 當 `replyType` 為 'specified' 時顯示
- **功能**: 等待指定用戶回覆
- **多選**: 支持多個指定用戶

### **數據格式**

#### **存儲格式**
- **最終格式**: 逗號分隔的電話號碼字符串
- **示例**: `"85212345678,85287654321,85211223344"`
- **電話格式**: 區號+電話號碼，無+號無空格

#### **內部格式**
- **選擇器內部**: JSON 格式存儲詳細信息
- **示例**:
  ```json
  {
    "users": [{"id": 1, "name": "張三", "phone": "85212345678"}],
    "contacts": [{"id": 1, "name": "李四", "whatsappNumber": "85287654321"}],
    "groups": ["group-id-1"],
    "hashtags": ["hashtag-id-1"],
    "useInitiator": true
  }
  ```

#### **特殊標記處理**
- **流程啟動人標記**: `${initiator}`
- **執行時替換**: 系統會自動將此標記替換為實際的流程啟動人電話號碼
- **替換邏輯**: 從當前流程實例的 InitiatedBy 字段獲取

## 🌐 **國際化支持**

### **新增翻譯鍵**
- **繁體中文**: `selectRecipients: '選擇收件人'`
- **簡體中文**: `selectRecipients: '选择收件人'`
- **英文**: `selectRecipients: 'Select Recipients'`

### **翻譯覆蓋**
- 所有 UI 文字都有對應的翻譯
- 支持運行時語言切換
- 統一的翻譯鍵命名規範

## 🔐 **安全與權限**

### **認證要求**
- **JWT Token**: 所有 API 調用都需要認證
- **多租戶**: 自動過濾公司級數據
- **權限控制**: 基於現有的用戶權限系統

### **數據安全**
- **輸入驗證**: 完整的電話號碼格式驗證
- **SQL 注入防護**: 參數化查詢
- **XSS 防護**: 前端輸入過濾

## 📊 **性能優化**

### **數據載入**
- **按需載入**: 只有切換到對應標籤頁才載入數據
- **並行請求**: Contact List Tab 並行載入聯絡人、群組和標籤
- **緩存策略**: 適當的數據緩存

### **用戶體驗**
- **載入狀態**: 顯示載入動畫
- **錯誤處理**: 友好的錯誤提示
- **響應式設計**: 適配不同屏幕尺寸

## 🚀 **部署與維護**

### **文件結構**
```
src/components/WorkflowDesigner/
├── components/
│   ├── RecipientSelector.js          # 主要選擇器組件
│   └── NodePropertyDrawer.js         # 更新的節點屬性抽屜
├── modals/
│   └── RecipientModal.js             # 模態框包裝器
└── hooks/
    └── useDataFetching.js            # 更新的數據獲取 Hook
```

### **依賴關係**
- **Ant Design**: UI 組件庫
- **Contact API**: 聯絡人管理系統
- **Workflow API**: 工作流執行系統
- **Language Context**: 國際化支持

## 📈 **未來規劃**

### **功能擴展**
- **用戶信息增強**: 根據電話號碼查詢用戶詳細信息
- **批量操作**: 支持批量匯入收件人
- **智能建議**: 基於歷史記錄的收件人建議
- **權限控制**: 基於角色的收件人選擇限制

### **技術升級**
- **實時更新**: WebSocket 實時更新收件人列表
- **離線支持**: 離線模式下的收件人選擇
- **性能優化**: 虛擬滾動和分頁載入
- **AI 集成**: 智能收件人推薦

---

**最後更新**: 2025年1月15日  
**功能版本**: v1.0  
**狀態**: 已完成開發並集成到工作流設計器

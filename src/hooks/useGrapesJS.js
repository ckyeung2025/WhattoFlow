import { useEffect, useState } from 'react';
import grapesjs from 'grapesjs';
import 'grapesjs/dist/css/grapes.min.css';
import 'grapesjs-preset-webpage';
import 'grapesjs-plugin-forms';

// ÂãïÊÖãËºâÂÖ•Ë™ûË®ÄË≥áÊ∫ê
const loadLanguageResources = async (language) => {
  try {
    let resources;
    switch (language) {
      case 'zh-SC':
        resources = await import('../locales/zh-SC.js');
        return resources.default;
      case 'zh-TC':
        resources = await import('../locales/zh-TC.js');
        return resources.default;
      case 'en':
        resources = await import('../locales/en.js');
        return resources.default;
      default:
        resources = await import('../locales/zh-TC.js');
        return resources.default;
    }
  } catch (error) {
    console.error('ËºâÂÖ•Ë™ûË®ÄË≥áÊ∫êÂ§±Êïó:', error);
    // ËøîÂõûÈªòË™çÁöÑÁπÅÈ´î‰∏≠Êñá
    return {
      eformDesigner: {
        welcomeMessage: 'Ê≠°Ëøé‰ΩøÁî®Ë°®ÂñÆË®≠Ë®àÂô®',
        welcomeDescription: 'Ë´ãÂæûÂ∑¶ÂÅ¥Èù¢ÊùøÊãñÊãΩÁµÑ‰ª∂Âà∞Ê≠§ËôïÈñãÂßãË®≠Ë®àÊÇ®ÁöÑË°®ÂñÆ„ÄÇ',
        exampleInput: 'Á§∫‰æãËº∏ÂÖ•Ê°Ü',
        exampleInputPlaceholder: 'Ë´ãËº∏ÂÖ•...'
      }
    };
  }
};

const useGrapesJS = (containerRef, initialHtmlContent) => {
  const [editor, setEditor] = useState(null);
  const [isReady, setIsReady] = useState(false);
  const [languageResources, setLanguageResources] = useState(null);

  useEffect(() => {
    if (!containerRef.current || editor) return;

    console.log('üöÄ ÈñãÂßãÂàùÂßãÂåñ GrapesJS Á∑®ËºØÂô®...');
    
    // Áç≤ÂèñÁî®Êà∂Ë™ûË®ÄË®≠ÁΩÆ
    const userLanguage = localStorage.getItem('language') || 'zh-TC';
    
    // ËºâÂÖ•Ë™ûË®ÄË≥áÊ∫ê‰∏¶ÂàùÂßãÂåñÁ∑®ËºØÂô®
    loadLanguageResources(userLanguage).then(resources => {
      setLanguageResources(resources);
      
      try {
        const grapesEditor = grapesjs.init({
          container: containerRef.current,
          height: '100%',
          width: 'auto',
          storageManager: false,
          plugins: ['gjs-preset-webpage'],
          pluginsOpts: {
            'gjs-preset-webpage': {}
          },
          canvas: {
            styles: [
              'https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css',
            ],
            scripts: [
              'https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js',
            ],
          },
          // Ë®≠ÂÇôÁÆ°ÁêÜÂô®ÈÖçÁΩÆ
          deviceManager: {
            devices: [
              {
                name: resources.eformDesigner?.grapesJs?.desktop || 'Desktop',
                width: '',
              },
              {
                name: resources.eformDesigner?.grapesJs?.tablet || 'Tablet',
                width: '768px',
                widthMedia: '992px',
              },
              {
                name: resources.eformDesigner?.grapesJs?.mobileLandscape || 'Mobile Landscape',
                width: '568px',
                widthMedia: '768px',
              },
              {
                name: resources.eformDesigner?.grapesJs?.mobilePortrait || 'Mobile Portrait',
                width: '320px',
                widthMedia: '480px',
              },
            ],
          },
          // Ê®£ÂºèÁÆ°ÁêÜÂô®ÈÖçÁΩÆ
          styleManager: {
            sectors: [
              {
                name: resources.eformDesigner?.grapesJs?.general || 'General',
                open: false,
                buildProps: [
                  'display',
                  'float',
                  'position',
                  'top',
                  'right',
                  'left',
                  'bottom',
                ],
                properties: [
                  {
                    property: 'display',
                    type: 'select',
                    defaults: 'block',
                    options: [
                      { value: 'block', name: resources.eformDesigner?.grapesJs?.block || 'Block' },
                      { value: 'inline', name: resources.eformDesigner?.grapesJs?.inline || 'Inline' },
                      { value: 'inline-block', name: resources.eformDesigner?.grapesJs?.inlineBlock || 'Inline Block' },
                      { value: 'flex', name: resources.eformDesigner?.grapesJs?.flex || 'Flex' },
                      { value: 'grid', name: resources.eformDesigner?.grapesJs?.grid || 'Grid' },
                    ],
                  },
                  {
                    property: 'float',
                    type: 'select',
                    defaults: 'none',
                    options: [
                      { value: 'none', name: resources.eformDesigner?.grapesJs?.none || 'None' },
                      { value: 'left', name: resources.eformDesigner?.grapesJs?.left || 'Left' },
                      { value: 'right', name: resources.eformDesigner?.grapesJs?.right || 'Right' },
                    ],
                  },
                  {
                    property: 'position',
                    type: 'select',
                    defaults: 'static',
                    options: [
                      { value: 'static', name: resources.eformDesigner?.grapesJs?.static || 'Static' },
                      { value: 'relative', name: resources.eformDesigner?.grapesJs?.relative || 'Relative' },
                      { value: 'absolute', name: resources.eformDesigner?.grapesJs?.absolute || 'Absolute' },
                      { value: 'fixed', name: resources.eformDesigner?.grapesJs?.fixed || 'Fixed' },
                    ],
                  },
                  {
                    property: 'top',
                    type: 'integer',
                    defaults: 'auto',
                    units: ['px', '%', 'em', 'rem'],
                  },
                  {
                    property: 'right',
                    type: 'integer',
                    defaults: 'auto',
                    units: ['px', '%', 'em', 'rem'],
                  },
                  {
                    property: 'left',
                    type: 'integer',
                    defaults: 'auto',
                    units: ['px', '%', 'em', 'rem'],
                  },
                  {
                    property: 'bottom',
                    type: 'integer',
                    defaults: 'auto',
                    units: ['px', '%', 'em', 'rem'],
                  },
                ],
              },
            ],
          },
          components: initialHtmlContent.trim() ? initialHtmlContent : `
            <div class="container">
              <div class="row">
                <div class="col-md-12">
                  <h1>${resources.eformDesigner?.welcomeMessage || 'Ê≠°Ëøé‰ΩøÁî®Ë°®ÂñÆË®≠Ë®àÂô®'}</h1>
                  <p>${resources.eformDesigner?.welcomeDescription || 'Ë´ãÂæûÂ∑¶ÂÅ¥Èù¢ÊùøÊãñÊãΩÁµÑ‰ª∂Âà∞Ê≠§ËôïÈñãÂßãË®≠Ë®àÊÇ®ÁöÑË°®ÂñÆ„ÄÇ'}</p>
                  <div class="form-group">
                    <label for="exampleInput">${resources.eformDesigner?.exampleInput || 'Á§∫‰æãËº∏ÂÖ•Ê°Ü'}</label>
                    <input type="text" class="form-control" id="exampleInput" placeholder="${resources.eformDesigner?.exampleInputPlaceholder || 'Ë´ãËº∏ÂÖ•...'}">
                  </div>
                </div>
              </div>
            </div>
          `,
          style: `
            body { 
              font-family: Arial, sans-serif; 
              margin: 0; 
              padding: 20px; 
              background-color: #f5f5f5; 
            }
            .container { 
              max-width: 800px; 
              margin: 0 auto; 
              background: white; 
              padding: 20px; 
              border-radius: 8px; 
              box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            }
            
            /* Light Theme Ëá™ÂÆöÁæ©Ê®£Âºè */
            .gjs-pn-views-container {
              background-color: #f8f9fa !important;
              border-color: #dee2e6 !important;
            }
            
            .gjs-pn-panel {
              background-color: #ffffff !important;
              border-color: #dee2e6 !important;
            }
            
            .gjs-pn-views {
              background-color: #f8f9fa !important;
            }
            
            .gjs-pn-btn {
              background-color: #ffffff !important;
              color: #495057 !important;
              border-color: #dee2e6 !important;
            }
            
            .gjs-pn-btn:hover {
              background-color: #e9ecef !important;
              color: #212529 !important;
            }
            
            .gjs-pn-btn.gjs-pn-active {
              background-color: #007bff !important;
              color: #ffffff !important;
            }
            
            .gjs-cv-canvas {
              background-color: #ffffff !important;
            }
            
            .gjs-block {
              background-color: #ffffff !important;
              border-color: #dee2e6 !important;
              color: #495057 !important;
            }
            
            .gjs-block:hover {
              background-color: #e9ecef !important;
            }
            
            .gjs-block-category {
              background-color: #f8f9fa !important;
              color: #495057 !important;
            }
            
            .gjs-layer-title {
              background-color: #ffffff !important;
              color: #495057 !important;
            }
            
            .gjs-layer-vis {
              background-color: #ffffff !important;
              color: #495057 !important;
            }
            
            .gjs-layer-caret {
              color: #495057 !important;
            }
            
            .gjs-property {
              background-color: #ffffff !important;
              color: #495057 !important;
            }
            
            .gjs-property input {
              background-color: #ffffff !important;
              color: #495057 !important;
              border-color: #dee2e6 !important;
            }
            
            .gjs-property select {
              background-color: #ffffff !important;
              color: #495057 !important;
              border-color: #dee2e6 !important;
            }
            
            .gjs-toolbar {
              background-color: #ffffff !important;
              border-color: #dee2e6 !important;
            }
            
            .gjs-toolbar-item {
              background-color: #ffffff !important;
              color: #495057 !important;
              border-color: #dee2e6 !important;
            }
            
            .gjs-toolbar-item:hover {
              background-color: #e9ecef !important;
            }
            
            .gjs-toolbar-item.gjs-active {
              background-color: #007bff !important;
              color: #ffffff !important;
            }
            
            /* input Âíå textarea ÁöÑÊ®£Âºè */
            .gjs-cv-canvas input,
            .gjs-cv-canvas textarea {
              background-color: #f8f9fa !important;
              color: #6c757d !important;
              border: 1px solid #dee2e6 !important;
              padding: 8px !important;
              font-size: 14px !important;
              line-height: 1.4 !important;
              opacity: 0.8 !important;
              cursor: text !important;
            }
            
            .gjs-cv-canvas input:hover,
            .gjs-cv-canvas textarea:hover {
              background-color: #e9ecef !important;
              border-color: #adb5bd !important;
            }
            
            /* Áï∂ÁµÑ‰ª∂Ë¢´ÈÅ∏‰∏≠ÊôÇÔºåÈ°ØÁ§∫ÊèêÁ§∫Ê®£Âºè */
            .gjs-selected input,
            .gjs-selected textarea {
              border: 2px solid #007bff !important;
              background-color: #f0f8ff !important;
            }
            
            /* Á¢∫‰øùÂ∑•ÂÖ∑Ê¨ÑÂèØ‰ª•ÈªûÊìä */
            .gjs-toolbar {
              pointer-events: auto !important;
              z-index: 1001 !important;
            }
            
            .gjs-toolbar-item {
              pointer-events: auto !important;
              cursor: pointer !important;
              z-index: 1002 !important;
            }
            
            /* Á¢∫‰øùÈÅ∏‰∏≠ÁöÑÁµÑ‰ª∂ÂÆπÂô®ÂèØ‰ª•Êé•Êî∂ÈªûÊìä‰∫ã‰ª∂ */
            .gjs-selected {
              pointer-events: auto !important;
            }
            
            /* ÊèêÁ§∫Ê°ÜÊ®£Âºè */
            .edit-tip {
              position: fixed;
              top: 50%;
              left: 50%;
              transform: translate(-50%, -50%);
              background: #fff;
              border: 2px solid #007bff;
              border-radius: 8px;
              padding: 20px;
              box-shadow: 0 4px 20px rgba(0,0,0,0.3);
              z-index: 10000;
              max-width: 300px;
              text-align: center;
              font-family: Arial, sans-serif;
            }
            
            .edit-tip h4 {
              margin: 0 0 10px 0;
              color: #007bff;
            }
            
            .edit-tip p {
              margin: 0 0 15px 0;
              color: #666;
            }
            
            .edit-tip button {
              background: #007bff;
              color: white;
              border: none;
              padding: 8px 16px;
              border-radius: 4px;
              cursor: pointer;
              font-size: 14px;
            }
            
            .edit-tip button:hover {
              background: #0056b3;
            }
            
            .edit-tip .close-btn {
              position: absolute;
              top: 10px;
              right: 10px;
              background: none;
              border: none;
              font-size: 18px;
              cursor: pointer;
              color: #999;
            }
            
            .edit-tip .close-btn:hover {
              color: #333;
            }
            
            /* ÂèñÊ∂àÈÅ∏‰∏≠ÊèêÁ§∫Ê®£Âºè */
            .deselect-tip {
              position: fixed;
              top: 20px;
              right: 20px;
              background: #fff;
              border: 2px solid #ffc107;
              border-radius: 8px;
              padding: 15px;
              box-shadow: 0 4px 20px rgba(0,0,0,0.3);
              z-index: 10000;
              max-width: 250px;
              text-align: center;
              font-family: Arial, sans-serif;
            }
            
            .deselect-tip h5 {
              margin: 0 0 8px 0;
              color: #ffc107;
            }
            
            .deselect-tip p {
              margin: 0;
              color: #666;
              font-size: 12px;
            }
          `,
        });

        // Ê∑ªÂä†Ëá™ÂÆöÁæ©ÂçÄÂ°ä
        addCustomBlocks(grapesEditor);
        
        // Ê∑ªÂä†Á∑®ËºØÂäüËÉΩ
        addEditFunctionality(grapesEditor);
        
        // Ê∑ªÂä†ÂèñÊ∂àÈÅ∏‰∏≠ÂäüËÉΩ
        addDeselectFunctionality(grapesEditor);
        
        // Ë®≠ÁΩÆÈù¢ÊùøÊ®ôÁ±§ÁøªË≠Ø
        setPanelLabels(grapesEditor, resources);

        setEditor(grapesEditor);
        setIsReady(true);
        
        console.log('‚úÖ GrapesJS Á∑®ËºØÂô®ÂàùÂßãÂåñÊàêÂäü');
        
      } catch (error) {
        console.error('‚ùå GrapesJS ÂàùÂßãÂåñÂ§±Êïó:', error);
        setIsReady(false);
      }
    }).catch(error => {
      console.error('‚ùå ËºâÂÖ•Ë™ûË®ÄË≥áÊ∫êÂ§±Êïó:', error);
      setIsReady(false);
    });

    return () => {
      if (editor) {
        console.log('üßπ Ê∏ÖÁêÜ GrapesJS Á∑®ËºØÂô®');
        editor.destroy();
      }
    };
  }, [containerRef.current]);

  return { editor, isReady, languageResources };
};

const addCustomBlocks = (editor) => {
  const blockManager = editor.BlockManager;
  
  // Áç≤ÂèñË™ûË®ÄË≥áÊ∫ê
  const userLanguage = localStorage.getItem('language') || 'zh-TC';
  let resources;
  
  // Ê†πÊìöË™ûË®ÄË®≠ÁΩÆÁç≤ÂèñÂ∞çÊáâÁöÑÁøªË≠Ø
  switch (userLanguage) {
    case 'zh-SC':
      resources = require('../locales/zh-SC.js').default;
      break;
    case 'zh-TC':
      resources = require('../locales/zh-TC.js').default;
      break;
    case 'en':
      resources = require('../locales/en.js').default;
      break;
    default:
      resources = require('../locales/zh-TC.js').default;
  }
  
  const t = resources.eformDesigner?.grapesJs || {};
  
  // ‰ΩàÂ±ÄÂÖÉÁ¥†
  blockManager.add('section', {
    label: t.section || 'Section',
    category: t.layout || 'Layout',
    content: '<section class="section"><h2>This is a section</h2><p>This is a box</p></section>',
    media: '<svg viewBox="0 0 24 24"><path d="M2 20h20V4H2v16zm18-2V6H4v12h16z"/></svg>'
  });
  
  blockManager.add('div', {
    label: t.div || 'Div',
    category: t.layout || 'Layout',
    content: '<div class="div-block"><p>This is a div block</p></div>',
    media: '<svg viewBox="0 0 24 24"><path d="M3 3h18v18H3V3zm16 16V5H5v14h14z"/></svg>'
  });
  
  blockManager.add('container', {
    label: t.container || 'Container',
    category: t.layout || 'Layout',
    content: '<div class="container"><div class="container-content"></div></div>',
    media: '<svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14z"/></svg>'
  });
  
  // ÊñáÂ≠óÂÖÉÁ¥†
  blockManager.add('text', {
    label: t.text || 'Text',
    category: t.basic || 'Basic',
    content: '<div data-gjs-type="text">Insert your text here</div>',
    media: '<svg viewBox="0 0 24 24"><path d="M2.5 4v3h5v12h3V7h5V4H2.5zM21.5 9h-9v3h3v7h3v-7h3V9z"/></svg>'
  });
  
  blockManager.add('heading', {
    label: t.heading || 'Heading',
    category: t.basic || 'Basic',
    content: '<h2>Insert your heading here</h2>',
    media: '<svg viewBox="0 0 24 24"><path d="M6 3h2v18H6zm3.5 12l3-6 3 6H9.5z"/></svg>'
  });
  
  blockManager.add('paragraph', {
    label: t.paragraph || 'Paragraph',
    category: t.basic || 'Basic',
    content: '<p>Insert your paragraph here</p>',
    media: '<svg viewBox="0 0 24 24"><path d="M3 17.25V21h1.75L17.81 9.94l-1.75-1.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 1.75 1.75 1.83-1.83z"/></svg>'
  });
  
  // Ë°®ÂñÆÂÖÉÁ¥†
  blockManager.add('form', {
    label: t.form || 'Form',
    category: t.forms || 'Forms',
    content: '<form class="form"><input type="text" placeholder="Enter text here" /></form>',
    media: '<svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>'
  });
  
  blockManager.add('input', {
    label: t.input || 'Input',
    category: t.forms || 'Forms',
    content: '<input type="text" placeholder="Enter text here" />',
    media: '<svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-5 14H4v-4h11v4zm0-5H4V9h11v4zm5 5h-4V9h4v9z"/></svg>'
  });
  
  blockManager.add('button', {
    label: t.button || 'Button',
    category: t.forms || 'Forms',
    content: '<button class="button">Click me</button>',
    media: '<svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>'
  });
  
  blockManager.add('textarea', {
    label: t.textarea || 'Textarea',
    category: t.forms || 'Forms',
    content: '<textarea placeholder="Enter your message here"></textarea>',
    media: '<svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-5 14H4v-4h11v4zm0-5H4V9h11v4zm5 5h-4V9h4v9z"/></svg>'
  });
  
  // Êõ¥Â§öË°®ÂñÆÊéß‰ª∂
  blockManager.add('select', {
    label: t.select || 'Select',
    category: t.forms || 'Forms',
    content: '<select><option value="">Ë´ãÈÅ∏Êìá...</option><option value="option1">ÈÅ∏È†Ö 1</option><option value="option2">ÈÅ∏È†Ö 2</option><option value="option3">ÈÅ∏È†Ö 3</option></select>',
    media: '<svg viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>'
  });
  
  blockManager.add('radio', {
    label: t.radio || 'Radio',
    category: t.forms || 'Forms',
    content: '<div><label><input type="radio" name="radio1" value="option1" /> ÈÅ∏È†Ö 1</label><br/><label><input type="radio" name="radio1" value="option2" /> ÈÅ∏È†Ö 2</label><br/><label><input type="radio" name="radio1" value="option3" /> ÈÅ∏È†Ö 3</label></div>',
    media: '<svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>'
  });
  
  blockManager.add('checkbox', {
    label: t.checkbox || 'Checkbox',
    category: t.forms || 'Forms',
    content: '<div><label><input type="checkbox" value="check1" /> ÈÅ∏È†Ö 1</label><br/><label><input type="checkbox" value="check2" /> ÈÅ∏È†Ö 2</label><br/><label><input type="checkbox" value="check3" /> ÈÅ∏È†Ö 3</label></div>',
    media: '<svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-9 14l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>'
  });
  
  blockManager.add('file-upload', {
    label: t.fileUpload || 'File Upload',
    category: t.forms || 'Forms',
    content: '<input type="file" />',
    media: '<svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11z"/></svg>'
  });
  
  blockManager.add('email', {
    label: t.email || 'Email',
    category: t.forms || 'Forms',
    content: '<input type="email" placeholder="Ë´ãËº∏ÂÖ•ÈõªÂ≠êÈÉµ‰ª∂" />',
    media: '<svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>'
  });
  
  blockManager.add('password', {
    label: t.password || 'Password',
    category: t.forms || 'Forms',
    content: '<input type="password" placeholder="Ë´ãËº∏ÂÖ•ÂØÜÁ¢º" />',
    media: '<svg viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg>'
  });
  
  blockManager.add('number', {
    label: t.number || 'Number',
    category: t.forms || 'Forms',
    content: '<input type="number" placeholder="Ë´ãËº∏ÂÖ•Êï∏Â≠ó" />',
    media: '<svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>'
  });
  
  blockManager.add('date', {
    label: t.date || 'Date',
    category: t.forms || 'Forms',
    content: '<input type="date" />',
    media: '<svg viewBox="0 0 24 24"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/></svg>'
  });
  
  blockManager.add('time', {
    label: t.time || 'Time',
    category: t.forms || 'Forms',
    content: '<input type="time" />',
    media: '<svg viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>'
  });
  
  blockManager.add('url', {
    label: t.url || 'URL',
    category: t.forms || 'Forms',
    content: '<input type="url" placeholder="Ë´ãËº∏ÂÖ•Á∂≤ÂùÄ" />',
    media: '<svg viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1s1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg>'
  });
  
  blockManager.add('tel', {
    label: t.tel || 'Phone',
    category: t.forms || 'Forms',
    content: '<input type="tel" placeholder="Ë´ãËº∏ÂÖ•ÈõªË©±ËôüÁ¢º" />',
    media: '<svg viewBox="0 0 24 24"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg>'
  });
  
  blockManager.add('label', {
    label: t.label || 'Label',
    category: t.forms || 'Forms',
    content: '<label for="input1">Ê®ôÁ±§ÊñáÂ≠ó</label>',
    media: '<svg viewBox="0 0 24 24"><path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/></svg>'
  });
  
  blockManager.add('fieldset', {
    label: t.fieldset || 'Fieldset',
    category: t.forms || 'Forms',
    content: '<fieldset><legend>Áæ§ÁµÑÊ®ôÈ°å</legend><input type="text" placeholder="Áæ§ÁµÑÂÖßËº∏ÂÖ•Ê°Ü" /></fieldset>',
    media: '<svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>'
  });
  
  console.log('‚úÖ Â∑≤Ê∑ªÂä† 27 ÂÄãËá™ÂÆöÁæ©ÂçÄÂ°ä');
};

// Ë®≠ÁΩÆ GrapesJS ÂÖßÂª∫Èù¢ÊùøÊ®ôÁ±§ÁøªË≠Ø
const setPanelLabels = (editor, resources) => {
  const t = resources.eformDesigner?.grapesJs || {};
  
  // Ë®≠ÁΩÆÈù¢ÊùøÊ®ôÁ±§
  const panels = editor.Panels;
  if (panels) {
    // Ë®≠ÁΩÆÂúñÂ±§Èù¢ÊùøÊ®ôÁ±§
    const layersPanel = panels.getPanel('layers');
    if (layersPanel) {
      const layersButton = layersPanel.get('buttons').at(0);
      if (layersButton) {
        layersButton.set('label', t.layers || 'Layers');
      }
    }
    
    // Ë®≠ÁΩÆÊ®£ÂºèÈù¢ÊùøÊ®ôÁ±§
    const stylesPanel = panels.getPanel('styles');
    if (stylesPanel) {
      const stylesButton = stylesPanel.get('buttons').at(0);
      if (stylesButton) {
        stylesButton.set('label', t.styles || 'Styles');
      }
    }
    
    // Ë®≠ÁΩÆÂ±¨ÊÄßÈù¢ÊùøÊ®ôÁ±§
    const traitsPanel = panels.getPanel('traits');
    if (traitsPanel) {
      const traitsButton = traitsPanel.get('buttons').at(0);
      if (traitsButton) {
        traitsButton.set('label', t.traits || 'Traits');
      }
    }
    
    // Ë®≠ÁΩÆÂçÄÂ°äÈù¢ÊùøÊ®ôÁ±§
    const blocksPanel = panels.getPanel('blocks');
    if (blocksPanel) {
      const blocksButton = blocksPanel.get('buttons').at(0);
      if (blocksButton) {
        blocksButton.set('label', t.blocks || 'Blocks');
      }
    }
  }
  
  // Ë®≠ÁΩÆË®≠ÂÇôÁÆ°ÁêÜÂô®Ê®ôÁ±§
  const deviceManager = editor.DeviceManager;
  if (deviceManager) {
    // Ë®≠ÁΩÆË®≠ÂÇôÈÅ∏ÊìáÂô®Ê®ôÁ±§
    const deviceButton = deviceManager.getDeviceButton();
    if (deviceButton) {
      deviceButton.set('label', t.device || 'Device');
    }
    
    // Ë®≠ÁΩÆË®≠ÂÇôÂêçÁ®±
    const devices = deviceManager.getAll();
    devices.forEach(device => {
      const deviceName = device.get('name');
      if (deviceName === 'Desktop') {
        device.set('name', t.desktop || 'Desktop');
      } else if (deviceName === 'Tablet') {
        device.set('name', t.tablet || 'Tablet');
      } else if (deviceName === 'Mobile Landscape') {
        device.set('name', t.mobileLandscape || 'Mobile Landscape');
      } else if (deviceName === 'Mobile Portrait') {
        device.set('name', t.mobilePortrait || 'Mobile Portrait');
      }
    });
  }
  
  // Ë®≠ÁΩÆË®≠ÂÇôÈÅ∏ÊìáÂô®Ê®ôÁ±§ÔºàÈÄöÈÅé DOM Êìç‰ΩúÔºâ
  setTimeout(() => {
    // ÂòóË©¶Â§öÂÄãÂèØËÉΩÁöÑÈÅ∏ÊìáÂô®
    const selectors = [
      '.gjs-devices-c',
      '.gjs-devices',
      '.gjs-devices-c .gjs-devices-label',
      '.gjs-devices .gjs-devices-label',
      '[data-id="device"]',
      '.gjs-pn-views-container .gjs-devices-c'
    ];
    
    selectors.forEach(selector => {
      const element = document.querySelector(selector);
      if (element) {
        // Â¶ÇÊûúÊòØÂÆπÂô®ÂÖÉÁ¥†ÔºåÊü•ÊâæÊ®ôÁ±§ÂÖÉÁ¥†
        const labelElement = element.querySelector('.gjs-devices-label') || element;
        if (labelElement && labelElement.textContent === 'Device') {
          labelElement.textContent = t.device || 'Device';
          console.log('‚úÖ Â∑≤ÁøªË≠ØË®≠ÂÇôÊ®ôÁ±§:', t.device || 'Device');
        }
      }
    });
    
    // Áõ£ËÅΩ DOM ËÆäÂåñÔºåÁ¢∫‰øùÊñ∞Ê∑ªÂä†ÁöÑÂÖÉÁ¥†‰πüË¢´ÁøªË≠Ø
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        mutation.addedNodes.forEach((node) => {
          if (node.nodeType === 1) { // ÂÖÉÁ¥†ÁØÄÈªû
            const deviceLabels = node.querySelectorAll && node.querySelectorAll('.gjs-devices-label');
            if (deviceLabels) {
              deviceLabels.forEach(label => {
                if (label.textContent === 'Device') {
                  label.textContent = t.device || 'Device';
                }
              });
            }
          }
        });
      });
    });
    
    observer.observe(document.body, {
      childList: true,
      subtree: true
    });
  }, 100);
  
  console.log('‚úÖ Â∑≤Ë®≠ÁΩÆ GrapesJS Èù¢ÊùøÊ®ôÁ±§ÁøªË≠Ø');
};

// ÂâµÂª∫ÊèêÁ§∫Ê°ÜÂáΩÊï∏
const showEditTip = (editor) => {
  // ÁßªÈô§ÁèæÊúâÁöÑÊèêÁ§∫Ê°Ü
  const existingTip = document.querySelector('.edit-tip');
  if (existingTip) {
    existingTip.remove();
  }
  
  // Áç≤ÂèñË™ûË®ÄË≥áÊ∫ê
  const userLanguage = localStorage.getItem('language') || 'zh-TC';
  let resources;
  
  // Ê†πÊìöË™ûË®ÄË®≠ÁΩÆÁç≤ÂèñÂ∞çÊáâÁöÑÁøªË≠Ø
  switch (userLanguage) {
    case 'zh-SC':
      resources = require('../locales/zh-SC.js').default;
      break;
    case 'zh-TC':
      resources = require('../locales/zh-TC.js').default;
      break;
    case 'en':
      resources = require('../locales/en.js').default;
      break;
    default:
      resources = require('../locales/zh-TC.js').default;
  }
  
  const t = resources.eformDesigner?.grapesJs || {};
  
  // ÂâµÂª∫ÊèêÁ§∫Ê°Ü
  const tip = document.createElement('div');
  tip.className = 'edit-tip';
  tip.innerHTML = `
    <button class="close-btn" onclick="this.parentElement.remove()">√ó</button>
    <h4>‚úèÔ∏è ${t.editTip ? 'Á∑®ËºØÊèêÁ§∫' : 'Edit Tip'}</h4>
    <p>${t.editTip || 'Please click the edit button above the component to modify this input field properties.'}</p>
    <button onclick="this.parentElement.remove()">${t.editTip ? 'Áü•ÈÅì‰∫Ü' : 'Got it'}</button>
  `;
  
  document.body.appendChild(tip);
  
  // 3ÁßíÂæåËá™ÂãïÈóúÈñâ
  setTimeout(() => {
    if (tip.parentElement) {
      tip.remove();
    }
  }, 3000);
};

// ÂâµÂª∫ÂèñÊ∂àÈÅ∏‰∏≠ÊèêÁ§∫ÂáΩÊï∏
const showDeselectTip = (editor) => {
  // ÁßªÈô§ÁèæÊúâÁöÑÊèêÁ§∫Ê°Ü
  const existingTip = document.querySelector('.deselect-tip');
  if (existingTip) {
    existingTip.remove();
  }
  
  // Áç≤ÂèñË™ûË®ÄË≥áÊ∫ê
  const userLanguage = localStorage.getItem('language') || 'zh-TC';
  let resources;
  
  // Ê†πÊìöË™ûË®ÄË®≠ÁΩÆÁç≤ÂèñÂ∞çÊáâÁöÑÁøªË≠Ø
  switch (userLanguage) {
    case 'zh-SC':
      resources = require('../locales/zh-SC.js').default;
      break;
    case 'zh-TC':
      resources = require('../locales/zh-TC.js').default;
      break;
    case 'en':
      resources = require('../locales/en.js').default;
      break;
    default:
      resources = require('../locales/zh-TC.js').default;
  }
  
  const t = resources.eformDesigner?.grapesJs || {};
  
  // ÂâµÂª∫ÊèêÁ§∫Ê°Ü
  const tip = document.createElement('div');
  tip.className = 'deselect-tip';
  tip.innerHTML = `
    <h5>üîç ${t.deselectTip ? 'ÈÅ∏ÊìáÊèêÁ§∫' : 'Selection Tip'}</h5>
    <p>${t.deselectTip || 'Press ESC key or click on blank area to deselect'}</p>
  `;
  
  document.body.appendChild(tip);
  
  // 2ÁßíÂæåËá™ÂãïÈóúÈñâ
  setTimeout(() => {
    if (tip.parentElement) {
      tip.remove();
    }
  }, 2000);
};

const addEditFunctionality = (editor) => {
  // ÁÇ∫ÁµÑ‰ª∂Ê∑ªÂä†Á∑®ËºØÂ∑•ÂÖ∑Ê¨Ñ
  editor.on('component:selected', function(component) {
    console.log('üéØ ÁµÑ‰ª∂Ë¢´ÈÅ∏‰∏≠:', component);
    
    const toolbar = component.get('toolbar') || [];
    const hasEditButton = toolbar.some(item => item.command === 'edit-component');
    
    if (!hasEditButton) {
      const newToolbar = [
        ...toolbar,
        {
          attributes: { class: 'gjs-toolbar-item' },
          command: 'edit-component',
          label: '‚úèÔ∏è',
          togglable: false,
          active: false,
          id: 'edit-component'
        }
      ];
      component.set('toolbar', newToolbar);
    }
  });
  
  // ÁÇ∫Êñ∞Ê∑ªÂä†ÁöÑ input Âíå textarea Ê∑ªÂä†ÊèêÁ§∫ÂäüËÉΩ
  editor.on('component:add', function(component) {
    const el = component.getEl();
    if (el && (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA')) {
      // Áõ£ËÅΩËº∏ÂÖ•‰∫ã‰ª∂ÔºåÈ°ØÁ§∫ÊèêÁ§∫
      const handleInput = function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        // ÊÅ¢Âæ©ÂéüÂßãÂÄº
        el.value = el.getAttribute('data-original-value') || '';
        
        // È°ØÁ§∫ÊèêÁ§∫
        showEditTip(editor);
        
        return false;
      };
      
      // Áõ£ËÅΩÁÑ¶Èªû‰∫ã‰ª∂
      const handleFocus = function(e) {
        // ‰øùÂ≠òÂéüÂßãÂÄº
        if (!el.getAttribute('data-original-value')) {
          el.setAttribute('data-original-value', el.value || '');
        }
      };
      
      // Áõ£ËÅΩÈªûÊìä‰∫ã‰ª∂
      const handleClick = function(e) {
        // ‰øùÂ≠òÂéüÂßãÂÄº
        if (!el.getAttribute('data-original-value')) {
          el.setAttribute('data-original-value', el.value || '');
        }
      };
      
      // Áõ£ËÅΩÈçµÁõ§‰∫ã‰ª∂
      const handleKeydown = function(e) {
        // ÂÖÅË®±‰∏Ä‰∫õÂü∫Êú¨Êìç‰ΩúÔºàÂ¶Ç Tab ÈçµÔºâ
        if (e.key === 'Tab' || e.key === 'Escape') {
          return true;
        }
        
        // ÈòªÊ≠¢ÂÖ∂‰ªñËº∏ÂÖ•
        e.preventDefault();
        e.stopPropagation();
        
        // È°ØÁ§∫ÊèêÁ§∫
        showEditTip(editor);
        
        return false;
      };
      
      // Ê∑ªÂä†‰∫ã‰ª∂Áõ£ËÅΩÂô®
      el.addEventListener('input', handleInput, true);
      el.addEventListener('focus', handleFocus, true);
      el.addEventListener('click', handleClick, true);
      el.addEventListener('keydown', handleKeydown, true);
      el.addEventListener('keypress', handleInput, true);
      el.addEventListener('paste', handleInput, true);
      el.addEventListener('cut', handleInput, true);
      
      console.log('üö´ Êñ∞ÁµÑ‰ª∂Ê∑ªÂä†Ëº∏ÂÖ•ÊèêÁ§∫:', el.tagName, 'ÁµÑ‰ª∂ID:', component.getId());
    }
  });
  
  // ÁÇ∫ÁèæÊúâÁöÑ input Âíå textarea Ê∑ªÂä†ÊèêÁ§∫ÂäüËÉΩ
  editor.on('component:selected', function(component) {
    const el = component.getEl();
    if (el && (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA')) {
      // Ê™¢Êü•ÊòØÂê¶Â∑≤Á∂ìÊ∑ªÂä†ÈÅé‰∫ã‰ª∂Áõ£ËÅΩÂô®
      if (el.getAttribute('data-has-tip-handlers')) {
        return;
      }
      
      // Ê®ôË®òÂ∑≤Ê∑ªÂä†‰∫ã‰ª∂Áõ£ËÅΩÂô®
      el.setAttribute('data-has-tip-handlers', 'true');
      
      // Áõ£ËÅΩËº∏ÂÖ•‰∫ã‰ª∂ÔºåÈ°ØÁ§∫ÊèêÁ§∫
      const handleInput = function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        // ÊÅ¢Âæ©ÂéüÂßãÂÄº
        el.value = el.getAttribute('data-original-value') || '';
        
        // È°ØÁ§∫ÊèêÁ§∫
        showEditTip(editor);
        
        return false;
      };
      
      // Áõ£ËÅΩÁÑ¶Èªû‰∫ã‰ª∂
      const handleFocus = function(e) {
        // ‰øùÂ≠òÂéüÂßãÂÄº
        if (!el.getAttribute('data-original-value')) {
          el.setAttribute('data-original-value', el.value || '');
        }
      };
      
      // Áõ£ËÅΩÈªûÊìä‰∫ã‰ª∂
      const handleClick = function(e) {
        // ‰øùÂ≠òÂéüÂßãÂÄº
        if (!el.getAttribute('data-original-value')) {
          el.setAttribute('data-original-value', el.value || '');
        }
      };
      
      // Áõ£ËÅΩÈçµÁõ§‰∫ã‰ª∂
      const handleKeydown = function(e) {
        // ÂÖÅË®±‰∏Ä‰∫õÂü∫Êú¨Êìç‰ΩúÔºàÂ¶Ç Tab ÈçµÔºâ
        if (e.key === 'Tab' || e.key === 'Escape') {
          return true;
        }
        
        // ÈòªÊ≠¢ÂÖ∂‰ªñËº∏ÂÖ•
        e.preventDefault();
        e.stopPropagation();
        
        // È°ØÁ§∫ÊèêÁ§∫
        showEditTip(editor);
        
        return false;
      };
      
      // Ê∑ªÂä†‰∫ã‰ª∂Áõ£ËÅΩÂô®
      el.addEventListener('input', handleInput, true);
      el.addEventListener('focus', handleFocus, true);
      el.addEventListener('click', handleClick, true);
      el.addEventListener('keydown', handleKeydown, true);
      el.addEventListener('keypress', handleInput, true);
      el.addEventListener('paste', handleInput, true);
      el.addEventListener('cut', handleInput, true);
      
      console.log('üö´ ÁèæÊúâÁµÑ‰ª∂Ê∑ªÂä†Ëº∏ÂÖ•ÊèêÁ§∫:', el.tagName, 'ÁµÑ‰ª∂ID:', component.getId());
    }
  });
  
  // Ë®ªÂÜäÁ∑®ËºØÂëΩ‰ª§
  editor.Commands.add('edit-component', {
    run: function(editor, sender, options) {
      console.log('üöÄ Á∑®ËºØÂëΩ‰ª§Ë¢´Ëß∏Áôº');
      
      const component = editor.getSelected();
      if (!component) {
        console.log('‚ùå Ê≤íÊúâÈÅ∏‰∏≠ÁöÑÁµÑ‰ª∂');
        return;
      }
      
      // Ëß∏ÁôºËá™ÂÆöÁæ©‰∫ã‰ª∂ÔºåËÆìÁà∂ÁµÑ‰ª∂ËôïÁêÜ
      editor.trigger('edit-component-requested', component);
    }
  });
};

// Ê∑ªÂä†ÂèñÊ∂àÈÅ∏‰∏≠ÂäüËÉΩ
const addDeselectFunctionality = (editor) => {
  // Áõ£ËÅΩÁµÑ‰ª∂ÈÅ∏‰∏≠‰∫ã‰ª∂
  editor.on('component:selected', function(component) {
    const el = component.getEl();
    
    // Ê™¢Êü•ÊòØÂê¶ÈÅ∏‰∏≠‰∫Ü body ÂÖÉÁ¥†
    if (el && el.tagName === 'BODY') {
      console.log('‚ö†Ô∏è Ê™¢Ê∏¨Âà∞ body Ë¢´ÈÅ∏‰∏≠ÔºåÈ°ØÁ§∫ÂèñÊ∂àÈÅ∏‰∏≠ÊèêÁ§∫');
      showDeselectTip(editor);
    }
  });
  
  // Ê∑ªÂä† ESC ÈçµÂèñÊ∂àÈÅ∏‰∏≠ÂäüËÉΩ
  editor.on('component:selected', function(component) {
    const handleKeydown = function(e) {
      if (e.key === 'Escape') {
        console.log('üîç ESC ÈçµÂèñÊ∂àÈÅ∏‰∏≠');
        editor.select(null);
        e.preventDefault();
        e.stopPropagation();
      }
    };
    
    // Ê∑ªÂä†ÂÖ®Â±ÄÈçµÁõ§‰∫ã‰ª∂Áõ£ËÅΩÂô®
    document.addEventListener('keydown', handleKeydown);
    
    // Ê∏ÖÁêÜÂáΩÊï∏
    return () => {
      document.removeEventListener('keydown', handleKeydown);
    };
  });
  
  // Ê∑ªÂä†ÈªûÊìäÁ©∫ÁôΩÂçÄÂüüÂèñÊ∂àÈÅ∏‰∏≠ÂäüËÉΩ
  editor.on('component:selected', function(component) {
    const canvas = editor.Canvas.getFrameEl();
    
    const handleCanvasClick = function(e) {
      // Ê™¢Êü•ÈªûÊìäÁöÑÊòØÂê¶ÊòØÁ©∫ÁôΩÂçÄÂüüÔºà‰∏çÊòØÁµÑ‰ª∂Ôºâ
      const target = e.target;
      
      // Â¶ÇÊûúÈªûÊìäÁöÑÊòØ canvas Êú¨Ë∫´Êàñ body ÂÖÉÁ¥†ÔºåÂèñÊ∂àÈÅ∏‰∏≠
      if (target === canvas || target.tagName === 'BODY' || target.classList.contains('gjs-cv-canvas')) {
        console.log('üîç ÈªûÊìäÁ©∫ÁôΩÂçÄÂüüÂèñÊ∂àÈÅ∏‰∏≠');
        editor.select(null);
        e.preventDefault();
        e.stopPropagation();
      }
    };
    
    canvas.addEventListener('click', handleCanvasClick);
    
    // Ê∏ÖÁêÜÂáΩÊï∏
    return () => {
      canvas.removeEventListener('click', handleCanvasClick);
    };
  });
  
  // Ê∑ªÂä†ÂèñÊ∂àÈÅ∏‰∏≠ÂëΩ‰ª§
  editor.Commands.add('deselect', {
    run: function(editor, sender, options) {
      console.log('üîç Âü∑Ë°åÂèñÊ∂àÈÅ∏‰∏≠ÂëΩ‰ª§');
      editor.select(null);
    }
  });
};

export default useGrapesJS; 